<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>UpscalerJS x2 Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: system-ui, sans-serif; background: #0f172a; color: #e5e7eb; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        .controls { background: #1e293b; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        button { padding: 10px 18px; margin-right: 8px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; }
        #runBtn { background: #3b82f6; color: white; }
        #runBtn:disabled { background: #475569; opacity: 0.6; }
        #downloadBtn { background: #10b981; color: white; }
        #downloadBtn:disabled { background: #475569; opacity: 0.6; }
        .preview { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px; }
        img { max-width: 100%; border: 1px solid #334155; background: #020617; display: block; }
        .status { margin-top: 12px; font-size: 14px; padding: 8px; background: #334155; border-radius: 4px; }
    </style>
</head>

<body>
<div class="container">
    <h1>UpscalerJS x2 (Fixed Version)</h1>

    <div class="controls">
        <input type="file" id="fileInput" accept="image/*">
        <button id="runBtn" disabled>アップスケール実行</button>
        <button id="downloadBtn" disabled>保存する</button>
    </div>

    <div id="status" class="status">ライブラリを読み込み中...</div>

    <div class="preview">
        <div>
            <p>【元画像】</p>
            <img id="inputImg">
        </div>
        <div>
            <p>【拡大後 (x2)】</p>
            <img id="outputImg">
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/upscaler@1.0.0-beta.17/dist/browser/umd/upscaler.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@upscalerjs/default-model@1.0.0-beta.17/dist/browser/umd/index.min.js"></script>

<script>
const fileInput = document.getElementById("fileInput");
const runBtn = document.getElementById("runBtn");
const downloadBtn = document.getElementById("downloadBtn");
const inputImg = document.getElementById("inputImg");
const outputImg = document.getElementById("outputImg");
const status = document.getElementById("status");

let upscaler = null;
let resultUrl = null;

// ライブラリの読み込みが完了してから初期化
window.onload = () => {
    try {
        // window.DefaultUpscalerModel は 3つ目のスクリプトから提供されます
        upscaler = new Upscaler({
            model: window.DefaultUpscalerModel
        });
        status.textContent = "準備完了：画像を選択してください";
    } catch (e) {
        status.textContent = "初期化失敗：ライブラリの読み込み順序に問題があります。";
        console.error(e);
    }
};

fileInput.onchange = () => {
    const file = fileInput.files[0];
    if (!file) return;
    
    // 前のURLを破棄してメモリを解放
    if (inputImg.src.startsWith('blob:')) URL.revokeObjectURL(inputImg.src);
    
    const url = URL.createObjectURL(file);
    inputImg.src = url;
    runBtn.disabled = false;
    downloadBtn.disabled = true;
    status.textContent = "「アップスケール実行」を押してください";
};

runBtn.onclick = async () => {
    if (!upscaler) return;

    status.textContent = "処理中...（数秒〜十数秒かかる場合があります）";
    runBtn.disabled = true;

    try {
        // 画像要素を直接渡して処理
        const result = await upscaler.upscale(inputImg);
        
        outputImg.src = result;
        resultUrl = result;
        downloadBtn.disabled = false;
        status.textContent = "完了！";
    } catch (err) {
        console.error("Upscale Error:", err);
        status.textContent = "エラーが発生しました: " + err.message;
    } finally {
        runBtn.disabled = false;
    }
};

downloadBtn.onclick = () => {
    if (!resultUrl) return;
    const a = document.createElement("a");
    a.href = resultUrl;
    a.download = "upscaled_x2.png";
    a.click();
};
</script>
</body>
</html>
