<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>Safe AI Upscaler</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: sans-serif; background: #0f172a; color: #f8fafc; padding: 20px; text-align: center; }
        .box { background: #1e293b; padding: 20px; border-radius: 12px; max-width: 800px; margin: auto; border: 1px solid #334155; }
        .status { margin: 15px 0; padding: 10px; background: #020617; color: #3b82f6; font-family: monospace; border-radius: 4px; }
        .preview { display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        img { max-width: 100%; height: auto; border: 1px solid #475569; background: #000; border-radius: 4px; width: 350px; }
        button { padding: 10px 20px; cursor: pointer; font-weight: bold; border-radius: 6px; border: none; background: #3b82f6; color: white; }
        button:disabled { background: #475569; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="box">
    <h2>ブラウザ完結型 AI拡大</h2>
    <p style="font-size: 0.8rem; opacity: 0.7;">画像はサーバーへ送信されません。あなたのPC内で処理されます。</p>
    
    <input type="file" id="fileInput" accept="image/*">
    <button id="runBtn" disabled>実行 (x2)</button>
    
    <div id="status" class="status">ライブラリをロード中...</div>

    <div class="preview">
        <div><small>元画像</small><br><img id="inputImg"></div>
        <div><small>AI拡大</small><br><img id="outputImg"></div>
    </div>
</div>

<script type="module">
    // Skypackは依存関係をパッケージ化した状態で提供してくれるため、404エラーに非常に強いです。
    import Upscaler from 'https://cdn.skypack.dev/upscaler';
    import x2 from 'https://cdn.skypack.dev/@upscalerjs/default-model/x2';

    const fileInput = document.getElementById('fileInput');
    const runBtn = document.getElementById('runBtn');
    const inputImg = document.getElementById('inputImg');
    const outputImg = document.getElementById('outputImg');
    const status = document.getElementById('status');

    let upscaler;

    // 初期化
    (async () => {
        try {
            upscaler = new Upscaler({ model: x2 });
            status.textContent = "準備完了！画像を選んでください。";
        } catch (e) {
            status.textContent = "ロード失敗。ブラウザのセキュリティ設定を確認してください。";
            console.error(e);
        }
    })();

    fileInput.onchange = () => {
        const file = fileInput.files[0];
        if (!file) return;
        inputImg.src = URL.createObjectURL(file);
        runBtn.disabled = false;
        status.textContent = "「実行」を押すとAI処理を開始します。";
    };

    runBtn.onclick = async () => {
        runBtn.disabled = true;
        status.textContent = "AI計算中...（初回は10〜20秒ほどかかります）";

        try {
            // upscale関数の呼び出し
            const result = await upscaler.upscale(inputImg);
            outputImg.src = result;
            status.textContent = "完了しました！画像を右クリックで保存できます。";
        } catch (err) {
            status.textContent = "エラー発生: " + err.message;
            console.error(err);
        } finally {
            runBtn.disabled = false;
        }
    };
</script>
</body>
</html>
